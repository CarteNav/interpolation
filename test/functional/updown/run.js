
var path = require('path'),
    sqlite3 = require('../sqlite3'),
    action = require('../action');

var fixture = {
  oa: path.resolve( __dirname, './oa.csv' ),
  street: path.resolve( __dirname, './osm.polylines' )
};

var db = {
  address: path.resolve( __dirname, './address.db' ),
  street: path.resolve( __dirname, './street.db' )
};

module.exports.functional = {};

// import data
module.exports.functional.import = function(test) {
  action.import(test, db, fixture);
};

// perform conflation
module.exports.functional.conflate = function(test) {
  action.conflate(test, db, fixture);
};

// check table schemas
module.exports.functional.schema = function(test) {
  action.check.schema(test, db);
};

// check table indexes
module.exports.functional.indexes = function(test) {
  action.check.indexes(test, db);
};

module.exports.functional.street_counts = function(test) {
  test('street db table counts', function(t) {

    // count polyline table
    var polylines = sqlite3.count( db.street, 'polyline' );
    t.equal(polylines, 44, 'count(polyline)');

    // count names table
    var names = sqlite3.count( db.street, 'names' );
    t.equal(names, 44, 'count(names)');

    // count rtree table
    var rtree = sqlite3.count( db.street, 'rtree' );
    t.equal(rtree, 44, 'count(rtree)');

    t.end();
  });
};

module.exports.functional.address_counts = function(test) {
  test('address db table counts', function(t) {

    // count address table
    var addresses = sqlite3.count( db.address, 'address' );
    t.equal(addresses, 171, 'count(address)');

    t.end();
  });
};

module.exports.functional.spotcheck = function(test) {
  test('spot checks', function(t) {

    // counts for a specific street
    var count1 = sqlite3.count( db.address, 'address', 'WHERE id=17' );
    t.equal(count1, 158);

    // counts for a specific street (open addresses)
    var count2 = sqlite3.count( db.address, 'address', 'WHERE id=17 AND source="OA"' );
    t.equal(count2, 130);

    // counts for a specific street (vertexes)
    var count3 = sqlite3.count( db.address, 'address', 'WHERE id=17 AND source="VERTEX"' );
    t.equal(count3, 28);

    t.end();
  });
};

// @todo: some of these vertex values seem to be wrong
module.exports.functional.end_to_end = function(test) {
  test('end to end', function(t) {

    // full interpolation for a single street
    var rows = sqlite3.exec( db.address, 'SELECT * FROM address WHERE id=17 ORDER BY housenumber' );
    t.deepEqual(rows, [
      '116|17|OA|1.0|52.5181593|13.4540245|R|52.5183712|13.4540644',
      '1|17|OA|1.1|52.5181676|13.4541247|R|52.5183532|13.4541597',
      '142|17|VERTEX|1.647||||52.517799|13.457112',
      '117|17|OA|2.0|52.5181761|13.4543727|R|52.5183084|13.4543975',
      '118|17|OA|3.0|52.5181347|13.454604|R|52.5182651|13.4546285',
      '2|17|OA|4.0|52.5180874|13.4548722|R|52.5182148|13.4548961',
      '3|17|OA|5.0|52.5180369|13.4551583|R|52.5181613|13.4551816',
      '110|17|OA|6.0|52.5179866|13.4554435|R|52.5181078|13.4554663',
      '143|17|VERTEX|6.265||||52.517612|13.458198',
      '127|17|OA|7.0|52.517957|13.4556096|R|52.5180767|13.4556321',
      '119|17|OA|8.0|52.5179136|13.4558537|R|52.518031|13.4558757',
      '120|17|OA|9.0|52.5178602|13.4561472|R|52.517976|13.4561689',
      '4|17|OA|10.0|52.5178143|13.4564022|R|52.5179282|13.4564236',
      '141|17|VERTEX|10.897||||52.51831|13.454389',
      '5|17|OA|12.0|52.5176578|13.4572844|R|52.5177661|13.457303',
      '6|17|OA|13.0|52.5176184|13.4575043|R|52.5177282|13.4575232',
      '150|17|VERTEX|13.842||||52.516357|13.465167',
      '7|17|OA|14.0|52.517569|13.4577793|R|52.5176808|13.4577985',
      '121|17|OA|15.0|52.5175284|13.4580058|R|52.5176417|13.4580253',
      '122|17|OA|16.0|52.5174873|13.4582345|R|52.5176023|13.4582543',
      '123|17|OA|16.1|52.5167765|13.4575346|R|52.5176989|13.4576934',
      '8|17|OA|17.0|52.5174483|13.4584525|R|52.5175647|13.4584726',
      '128|17|OA|17.1|52.517189|13.4582929|R|52.5175839|13.458361',
      '129|17|OA|17.2|52.5171445|13.4582422|R|52.5175911|13.4583192',
      '130|17|OA|17.3|52.5171001|13.4581954|R|52.5175977|13.4582812',
      '148|17|VERTEX|17.673||||52.516616|13.463785',
      '131|17|OA|18.0|52.5173993|13.458721|R|52.5175183|13.4587415',
      '133|17|OA|18.1|52.5171691|13.4586768|R|52.5175191|13.4587371',
      '134|17|OA|18.2|52.5169644|13.4589145|R|52.5174734|13.4590022',
      '135|17|OA|18.3|52.5168482|13.4588171|R|52.5174863|13.4589271',
      '136|17|OA|18.4|52.5168882|13.4585878|R|52.5175259|13.4586977',
      '137|17|OA|18.5|52.5169547|13.4582482|R|52.5175846|13.4583568',
      '138|17|OA|18.6|52.516766|13.4581569|R|52.5175945|13.4582997',
      '139|17|OA|18.7|52.516661|13.4584243|R|52.5175467|13.458577',
      '140|17|OA|18.8|52.516584|13.4586361|R|52.517509|13.4587955',
      '124|17|OA|19.0|52.5173805|13.4588312|R|52.5174993|13.4588517',
      '147|17|VERTEX|19.69||||52.516746|13.463056',
      '9|17|OA|20.0|52.5173306|13.45911|R|52.5174512|13.4591308',
      '10|17|OA|21.0|52.5172902|13.4593359|R|52.5174123|13.4593569',
      '111|17|OA|22.0|52.5171656|13.460029|R|52.5172927|13.4600509',
      '11|17|OA|23.0|52.5170485|13.4606884|R|52.5171693|13.460711',
      '12|17|OA|24.0|52.5169075|13.4614761|R|52.5170252|13.4614972',
      '13|17|OA|25.0|52.5168569|13.4617594|R|52.5169745|13.4617805',
      '146|17|VERTEX|25.051||||52.517093|13.461119',
      '14|17|OA|26.0|52.5168108|13.4620177|R|52.5169282|13.4620387',
      '15|17|OA|27.0|52.5167475|13.4623445|R|52.5168695|13.4623664',
      '16|17|OA|28.0|52.5167077|13.4625941|R|52.516825|13.4626151',
      '145|17|VERTEX|28.001||||52.517292|13.460055',
      '17|17|OA|28.1|52.5166738|13.4627835|R|52.5167911|13.4628045',
      '168|17|VERTEX|29.755||||52.514865|13.473402',
      '23|17|OA|30.0|52.5165559|13.4634424|R|52.5166734|13.4634633',
      '166|17|VERTEX|30.431||||52.514942|13.473119',
      '144|17|VERTEX|30.632||||52.517456|13.459103',
      '24|17|OA|31.0|52.5164525|13.464026|R|52.5165668|13.4640474',
      '164|17|VERTEX|31.172||||52.515003|13.472803',
      '25|17|OA|32.0|52.5164032|13.4643039|R|52.5165148|13.4643248',
      '26|17|OA|33.0|52.5163544|13.4645794|R|52.5164633|13.4645998',
      '162|17|VERTEX|33.304||||52.515171|13.471892',
      '27|17|OA|35.0|52.5161954|13.4654536|R|52.516307|13.4654719',
      '28|17|OA|36.0|52.516017|13.4660726|R|52.5162024|13.4661064',
      '154|17|VERTEX|36.464||||52.516017|13.467123',
      '29|17|OA|37.0|52.516017|13.4660726|R|52.5162024|13.4661064',
      '160|17|VERTEX|37.105||||52.515457|13.470266',
      '30|17|OA|38.0|52.516017|13.4660726|R|52.5162024|13.4661064',
      '31|17|OA|39.0|52.5159796|13.4666581|R|52.5160979|13.4666797',
      '152|17|VERTEX|39.978||||52.516208|13.466076',
      '115|17|OA|40.0|52.5159286|13.4669414|R|52.5160462|13.4669629',
      '158|17|VERTEX|40.794||||52.515739|13.468689',
      '32|17|OA|41.0|52.5158811|13.4672077|R|52.5159981|13.4672286',
      '33|17|OA|42.0|52.5158214|13.4675383|R|52.515939|13.4675593',
      '156|17|VERTEX|42.061||||52.515834|13.468147',
      '34|17|OA|42.1|52.5157811|13.4677659|R|52.5158984|13.4677869',
      '35|17|OA|43.0|52.5156695|13.4682736|R|52.5158076|13.4682978',
      '36|17|OA|43.1|52.5156069|13.4687447|R|52.5157253|13.4687659',
      '37|17|OA|44.0|52.5155336|13.469152|R|52.5156524|13.4691732',
      '38|17|OA|44.1|52.5154846|13.4694316|R|52.5156024|13.4694527',
      '39|17|OA|45.0|52.5154389|13.4696803|R|52.5155579|13.4697016',
      '40|17|OA|46.0|52.5153989|13.4699064|R|52.5155175|13.4699276',
      '42|17|OA|48.0|52.5153133|13.470389|R|52.5154317|13.4704098',
      '43|17|OA|49.0|52.5152812|13.470569|R|52.5154|13.4705899',
      '44|17|OA|50.0|52.5152347|13.4708324|R|52.5153537|13.4708533',
      '45|17|OA|51.0|52.515196|13.4710486|R|52.5153156|13.4710696',
      '46|17|OA|52.0|52.5151292|13.471422|R|52.5152499|13.4714432',
      '106|17|OA|53.0|52.5149274|13.4721436|R|52.5151181|13.4721788',
      '107|17|OA|54.0|52.5148523|13.4725712|R|52.5150394|13.4726057',
      '47|17|OA|55.0|52.5145399|13.4741008|R|52.5146482|13.4741329',
      '48|17|OA|55.1|52.5144751|13.4743328|R|52.514606|13.474275',
      '49|17|OA|55.2|52.515206|13.4740943|L|52.5147038|13.4739453',
      '50|17|OA|56.0|52.5148726|13.4738047|L|52.5147558|13.4737701',
      '167|17|VERTEX|56.366||||52.514865|13.473402',
      '165|17|VERTEX|56.645||||52.514942|13.473119',
      '163|17|VERTEX|56.952||||52.515003|13.472803',
      '51|17|OA|57.0|52.5153421|13.4715556|L|52.5152335|13.4715365',
      '52|17|OA|57.1|52.5154134|13.4711609|L|52.515303|13.4711415',
      '53|17|OA|57.2|52.5153736|13.47138|L|52.5152644|13.4713608',
      '161|17|VERTEX|57.835||||52.515171|13.471892',
      '54|17|OA|58.0|52.5154634|13.4708777|L|52.5153528|13.4708583',
      '55|17|OA|59.0|52.5157684|13.4707552|L|52.5153829|13.4706874',
      '56|17|OA|59.1|52.5154901|13.4707282|L|52.5153791|13.4707087',
      '57|17|OA|60.0|52.5155516|13.4703847|L|52.5154396|13.470365',
      '159|17|VERTEX|60.732||||52.515457|13.470266',
      '58|17|OA|61.0|52.515593|13.4701532|L|52.5154808|13.4701331',
      '59|17|OA|62.0|52.5156392|13.4698946|L|52.515527|13.4698745',
      '60|17|OA|63.0|52.5156788|13.4696736|L|52.5155665|13.4696535',
      '61|17|OA|64.0|52.5157277|13.4693999|L|52.5156155|13.4693798',
      '62|17|OA|65.0|52.5157705|13.4691608|L|52.5156582|13.4691407',
      '157|17|VERTEX|65.482||||52.515739|13.468689',
      '63|17|OA|66.0|52.515816|13.4689061|L|52.5157038|13.468886',
      '132|17|OA|67.0|52.5158922|13.4685241|L|52.5157716|13.468503',
      '155|17|VERTEX|67.163||||52.515834|13.468147',
      '64|17|OA|68.0|52.5160258|13.4677331|L|52.5159116|13.4677127',
      '65|17|OA|69.0|52.5160696|13.4674885|L|52.5159553|13.4674681',
      '153|17|VERTEX|69.899||||52.516017|13.467123',
      '66|17|OA|70.0|52.516116|13.467229|L|52.5160017|13.4672086',
      '67|17|OA|71.0|52.5161499|13.4670386|L|52.5160362|13.4670179',
      '68|17|OA|72.0|52.5162049|13.4667313|L|52.5160922|13.4667107',
      '151|17|VERTEX|72.63||||52.516208|13.466076',
      '108|17|OA|73.0|52.5162842|13.466287|L|52.5161732|13.4662668',
      '109|17|OA|73.1|52.5165173|13.4661|L|52.5162123|13.46605',
      '69|17|OA|74.0|52.5163624|13.4658505|L|52.516248|13.4658318',
      '149|17|VERTEX|74.994||||52.516357|13.465167',
      '70|17|OA|75.0|52.5164191|13.4655338|L|52.5163001|13.4655143',
      '71|17|OA|76.0|52.5165578|13.4647574|L|52.516438|13.4647349',
      '72|17|OA|77.0|52.5166147|13.4644387|L|52.5164976|13.4644168',
      '73|17|OA|78.0|52.5166626|13.4641712|L|52.5165477|13.4641497',
      '74|17|OA|79.0|52.5167132|13.463888|L|52.5166006|13.4638669',
      '75|17|OA|80.0|52.5167486|13.4636904|L|52.5166364|13.4636704',
      '76|17|OA|81.0|52.5169269|13.4628164|L|52.5167932|13.4627925',
      '77|17|OA|82.0|52.5169269|13.4628164|L|52.5167932|13.4627925',
      '78|17|OA|83.0|52.5170609|13.4619433|L|52.5169489|13.4619232',
      '79|17|OA|84.0|52.5171159|13.4616362|L|52.5170039|13.4616161',
      '80|17|OA|85.0|52.5172819|13.4607036|L|52.5171745|13.4606835',
      '81|17|OA|86.0|52.5173283|13.4604445|L|52.5172228|13.4604248',
      '82|17|OA|87.0|52.5174437|13.4602366|L|52.5172643|13.460203',
      '83|17|OA|87.1|52.5174779|13.4600433|L|52.5172993|13.4600125',
      '84|17|OA|88.0|52.5175184|13.4598173|L|52.5173383|13.4597863',
      '114|17|OA|89.0|52.517556|13.459598|L|52.5173761|13.459567',
      '85|17|OA|90.0|52.5175417|13.4593857|L|52.5174112|13.4593632',
      '86|17|OA|91.0|52.5176381|13.4588339|L|52.5175063|13.4588112',
      '87|17|OA|92.0|52.5177289|13.4586781|L|52.517535|13.4586447',
      '88|17|OA|92.1|52.51776|13.4585037|L|52.5175651|13.4584701',
      '89|17|OA|93.0|52.517726|13.4582205|L|52.5176115|13.4582008',
      '90|17|OA|94.0|52.517772|13.4579617|L|52.5176561|13.4579417',
      '91|17|OA|95.0|52.5178095|13.4577507|L|52.5176925|13.4577306',
      '92|17|OA|96.0|52.5178569|13.4574837|L|52.5177385|13.4574633',
      '93|17|OA|97.0|52.5179713|13.4568436|L|52.5178535|13.4568215',
      '94|17|OA|98.0|52.5180285|13.4565344|L|52.5179115|13.4565124',
      '95|17|OA|99.0|52.518077|13.4562624|L|52.5179625|13.4562409',
      '96|17|OA|100.0|52.5181116|13.4560686|L|52.5179988|13.4560474',
      '97|17|OA|100.1|52.5181469|13.4558707|L|52.5180359|13.4558499',
      '98|17|OA|101.0|52.5181854|13.455654|L|52.5180764|13.4556336',
      '99|17|OA|102.0|52.5182277|13.4554156|L|52.5181211|13.4553956',
      '100|17|OA|103.0|52.5182638|13.4552124|L|52.5181592|13.4551928',
      '101|17|OA|104.0|52.5183037|13.4549883|L|52.5182011|13.4549691',
      '102|17|OA|105.0|52.5183429|13.4547691|L|52.5182422|13.4547502',
      '103|17|OA|106.0|52.5183872|13.4545219|L|52.5182885|13.4545034',
      '104|17|OA|107.0|52.5184935|13.454327|L|52.5183276|13.4542957',
      '105|17|OA|108.0|52.518488|13.4540511|L|52.5183776|13.4540303'
    ]);

    t.end();
  });
};


// write geojson to disk
module.exports.functional.geojson = function(test) {

  // full interpolation for a single street
  var rows = sqlite3.exec( db.address, 'SELECT * FROM address WHERE id=17 ORDER BY housenumber' );

  // destination path
  var destination = path.resolve(__dirname, 'preview.geojson');

  action.geojson(test, rows, destination);
};

// write tsv to disk
module.exports.functional.tsv = function(test) {

  // full interpolation for a single street
  var rows = sqlite3.exec( db.address, 'SELECT * FROM address WHERE id=17 ORDER BY housenumber' );

  // destination path
  var destination = path.resolve(__dirname, 'preview.tsv');

  action.tsv(test, rows, destination);
};

module.exports.all = function (tape) {

  function test(name, testFunction) {
    return tape('functional: updown: ' + name, testFunction);
  }

  for( var testCase in module.exports.functional ){
    module.exports.functional[testCase](test);
  }
};
