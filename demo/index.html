<!DOCTYPE html>
<html>
<head>
  <title>Interpolation Demo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1">

  <!-- jquery -->
  <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>

  <!-- Load Leaflet from CDN -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.1/leaflet.js"></script>

  <!-- Load geocoding plugin after Leaflet -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.7.1/leaflet-geocoder-mapzen.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-geocoder-mapzen/1.7.1/leaflet-geocoder-mapzen.js"></script>

  <link rel="stylesheet" href="map.css">
</head>
<body>
  <div id="map"></div>
  <script>
    // Create a basic Leaflet map
    var map = L.map('map', { zoomControl:false }).setView([40.7259, -73.9805], 12);
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
    }).addTo(map);

    var API_KEY = 'search-S0p1Seg';

    // Add geocoding plugin
    var params = {};
    var options = { focus: true, expanded: true, params: params };
    var geocoder = L.control.geocoder(API_KEY, options).addTo(map);
    map.locate({ setView: true, maxZoom: 16 });

    var layer = newSimpleStyleLayer().addTo(map);

    function reverse( latlng, cb ){
      // use map center when latlng not supplied
      if( !latlng ){ latlng = map.getCenter(); }

      var qs =  '?point.lat=' + latlng.lat;
          qs += '&point.lon=' + latlng.lng;
          qs += '&sources=oa';
          qs += '&layers=address';
          qs += '&size=1';
          qs += '&api_key=' + API_KEY;

      // find nearest street
      $.ajax({
        url: "https://search.mapzen.com/v1/reverse" + qs,
        method: "GET",
        dataType: "json",
        traditional: true,
        success: function( data, status, jqxhr ){
          // console.log( "Request received:", data );
          cb( null, data );
        },
        error: function( jqxhr, status, error ){
          // console.log( "Something went wrong!" );
          cb( error );
        }
      });
    }

    function extract( latlng, names, cb ){
      // use map center when latlng not supplied
      if( !latlng ){ latlng = map.getCenter(); }

      $.ajax({
        dataType: "json",
        url: "/extract/geojson?lat="+latlng.lat+"&lon="+latlng.lng+"&names="+names.join(','),
        success: function(data) {
          // console.error( JSON.stringify( data, null, 2 ) );
          cb( null, data );
        }
      }).error(function( err ) {
        console.error( err );
        cb( err );
      });
    }

    function streetById( id, cb ){
      $.ajax({
        dataType: "json",
        url: "/street/"+id+"/geojson",
        success: function(data) {
          console.error( JSON.stringify( data, null, 2 ) );
          cb( null, data );
        }
      }).error(function( err ) {
        console.error( err );
        cb( err );
      });
    }

    function update( latlng ){

      // use map center when latlng not supplied
      if( !latlng ){ latlng = map.getCenter(); }

      reverse( latlng, function( err, data ){

        if( data && data.features.length ){

          var centroid = latlng;
          var names = data.features.map( function( street ){
            return street.properties.street;
          });

          extract( centroid, names, function( err2, data2 ){

            console.error( err2, data2 );
            layer.clearLayers();

            if( !err2 && data2 && data2.features.length ){

              // add extract geojson to layer
              layer.addData( data2 );

              streetById( data2.features[0].properties.id, function( err3, data3 ){

                console.error( err3, data3 );
                if( !err3 && data3 ){

                  // add street geojson to layer
                  layer.addData( data3 );

                }
              })
            }
          });
        }
      });
    }

    // map.on('moveend', function(e){ update() });
    // map.on('resize', function(e){ update() });
    map.on('click', function(e){ update( e.latlng ); });

    // create a geojson layer which supports the simplestyle spec
    function newSimpleStyleLayer(){
      return new L.GeoJSON( null, {
        pointToLayer: function(f, latlon) {
          var sizes = {
            small: [20, 50],
            medium: [30, 70],
            large: [35, 90]
          };
          var fp = f.properties || {};
          var size = fp['marker-size'] || 'medium';
          var symbol = (fp['marker-symbol']) ? '-' + fp['marker-symbol'] : '';
          var color = fp['marker-color'] || '7e7e7e';
          color = color.replace('#', '');
          var url = 'http://a.tiles.mapbox.com/v3/marker/' +
                'pin-' +
                // Internet Explorer does not support the `size[0]` syntax.
                size.charAt(0) + symbol + '+' + color +
                ((window.devicePixelRatio === 2) ? '@2x' : '') +
                '.png';

          var table = '<table class="marker-properties"><tbody>';
          for( var attr in f.properties ){
            if( attr.match(/id/) ){ continue; }
            if( attr.match(/marker/) ){ continue; }
            if( f.properties[attr] === null || f.properties[attr] === undefined ){ continue; }
            table += '<tr><th>' + attr + '</th><td>' + f.properties[attr] + '</td></tr>'
          }
          table += '</tbody></table>';

          return new L.Marker(latlon, {
              icon: new L.icon({
                  iconUrl: url,
                  iconSize: sizes[size],
                  iconAnchor: [sizes[size][0] / 2, sizes[size][1] / 2],
                  popupAnchor: [sizes[size][0] / 2, 0]
              })
          }).bindPopup(table);
        }
    });
    }
  </script>
</body>
</html>
